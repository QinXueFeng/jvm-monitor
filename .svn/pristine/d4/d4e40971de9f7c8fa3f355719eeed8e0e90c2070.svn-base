package com.andaily.service.operation.instance;


import com.andaily.domain.application.ThreadInstance;
import com.andaily.domain.application.ThreadInstanceRepository;
import com.andaily.domain.shared.BeanProvider;
import com.andaily.infrastructure.scheduler.DynamicJob;
import com.andaily.infrastructure.scheduler.DynamicSchedulerFactory;

import org.quartz.SchedulerException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * @author Shengzhao Li
 */
public class MonitoringThreadInstanceKiller {

    private static final Logger LOGGER = LoggerFactory.getLogger(MonitoringThreadInstanceKiller.class);
    private transient ThreadInstanceRepository instanceRepository = BeanProvider.getBean(ThreadInstanceRepository.class);
    private String guid;

    public MonitoringThreadInstanceKiller(String guid) {
        this.guid = guid;
    }

    /*
     * 1. Remove the job
     * 2. update instance to enabled=false
     *
     */
    public boolean kill() {
        final ThreadInstance instance = instanceRepository.findByGuid(guid, ThreadInstance.class);
        if (!instance.enabled()) {
         //   LOGGER.debug("<{}> Expect ThreadInstance[guid={}] enabled=true,but it is false, illegal status",
          //          SecurityUtils.currentUsername(), instance.guid());
            return false;
        }

        if (!pauseJob(instance)) {
           // LOGGER.debug("<{}> Pause Job[name={}] failed", SecurityUtils.currentUsername(), instance.jobName());
            return false;
        }

        //update
        instance.enabled(false);
        //LOGGER.debug("<{}> Update ThreadInstance[guid={}] enabled=false", SecurityUtils.currentUsername(), instance.guid());
        return true;
    }

    private boolean pauseJob(ThreadInstance instance) {
        DynamicJob job = new DynamicJob(instance.jobName());
        try {
            return DynamicSchedulerFactory.pauseJob(job);
        } catch (SchedulerException e) {
         //   LOGGER.error("<{}> Pause [" + job + "] failed", SecurityUtils.currentUsername(), e);
            return false;
        }
    }
}